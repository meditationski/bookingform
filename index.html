<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ski School Booking</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <style>
        :root {
            --bg-primary: #222529; --bg-secondary: #2a2e33; --bg-tertiary: #3a3f45;
            --bg-accent: #254d63; --text-primary: #fff; --text-secondary: #858e96;
            --text-accent: #00A3FF; --text-error: #ff4757;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg-primary); font-family: 'Inter', sans-serif; color: var(--text-secondary); line-height: 1.4; }
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        .section { display: none; }
        .section.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .tabs { display: flex; background: var(--bg-secondary); border-radius: 8px; padding: 4px; gap: 4px; }
        .tab { flex: 1; padding: 12px; text-align: center; background: transparent; border: none; 
               color: var(--text-secondary); font-weight: 600; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .tab.active { background: var(--text-accent); color: var(--text-primary); }
        .custom-select, .form-input { width: 100%; padding: 14px 16px; border: 1px solid var(--bg-tertiary);
            border-radius: 8px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary); }
        .form-input { background: var(--bg-primary); }
        .custom-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M3 4.5L6 7.5L9 4.5' stroke='%23858e96' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 16px center; padding-right: 40px; }
        .slider-value { text-align: center; font-weight: 600; color: var(--text-accent); font-size: 14px; margin: 8px 0; }
        input[type="range"] { width: 100%; height: 6px; background: var(--bg-tertiary); border-radius: 3px; margin: 12px 0; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--text-accent); border-radius: 50%; cursor: pointer; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); }
        .two-column { display: flex; flex-direction: column; gap: 20px; }
        @media (min-width: 768px) { .two-column { flex-direction: row; } .col { flex: 1; } }
        .calendar { background: var(--bg-secondary); border-radius: 8px; padding: 15px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-month { font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .calendar-nav button { background: var(--bg-tertiary); border: none; color: var(--text-primary); 
            width: 32px; height: 32px; border-radius: 6px; cursor: pointer; }
        .calendar-weekdays, .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-weekdays { text-align: center; margin-bottom: 10px; font-size: 11px; color: var(--text-secondary); }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border: none; 
            background: transparent; color: var(--text-secondary); font-size: 13px; border-radius: 6px; cursor: pointer; min-height: 36px; }
        .calendar-day:hover:not(.disabled):not(.selected) { background: var(--bg-tertiary); }
        .calendar-day.selected { background: var(--text-accent); color: var(--text-primary); }
        .calendar-day.today { border: 1px solid var(--text-accent); }
        .calendar-day.disabled, .calendar-day.other-month { opacity: 0.2; cursor: not-allowed; }
        .time-selection { background: var(--bg-secondary); border-radius: 8px; padding: 15px; }
        .time-slots { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        @media (min-width: 480px) { .time-slots { grid-template-columns: repeat(3, 1fr); } }
        .time-slot { padding: 12px; background: var(--bg-tertiary); border: none; border-radius: 6px; 
            color: var(--text-primary); font-size: 13px; cursor: pointer; text-align: center; }
        .time-slot.selected { background: var(--text-accent); }
        .selected-info { text-align: center; margin-top: 16px; font-size: 14px; color: var(--text-accent); 
            font-weight: 600; padding: 12px; background: rgba(0, 163, 255, 0.1); border-radius: 6px; }
        .price-box { background: var(--bg-accent); color: var(--text-primary); padding: 15px; border-radius: 8px; margin-top: 20px; }
        .price-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
        .total-price { font-size: 24px; font-weight: 700; }
        .discount-info { text-align: center; margin-top: 10px; font-size: 12px; color: var(--text-accent); 
            padding: 8px; background: rgba(0, 163, 255, 0.1); }
        .buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; padding-top: 20px; }
        .btn { border: none; border-radius: 8px; padding: 16px 30px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-primary { background: var(--text-accent); color: var(--text-primary); }
        .btn:disabled { background: var(--bg-tertiary); cursor: not-allowed; }
        .form-row { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        @media (min-width: 768px) { .form-row { grid-template-columns: 1fr 1fr; } }
        .full-width { grid-column: 1 / -1; }
        .error { font-size: 12px; color: var(--text-error); margin-top: 4px; display: none; }
        .error.show { display: block; }
        .success { text-align: center; padding: 50px 20px; }
        .success-icon { font-size: 64px; margin-bottom: 25px; }
        .success-title { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 15px; }
        .title { font-size: 20px; font-weight: 700; color: var(--text-primary); text-align: center; margin-bottom: 30px; }
        #phone { padding-left: 80px !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Step 1 -->
        <div class="section active" id="step1">
            <div class="two-column">
                <div class="col">
                    <div class="form-group">
                        <div class="tabs">
                            <div class="tab active" data-sport="ski">Ski</div>
                            <div class="tab" data-sport="snowboard">Snowboard</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <select class="custom-select" id="duration">
                            <option value="2">2 hours - $100</option>
                            <option value="3">3 hours - $140</option>
                            <option value="full">Full day - $250</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="slider-value" id="participantsValue">1 Person</div>
                        <input type="range" id="participants" min="1" max="5" value="1">
                        <div class="slider-labels"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>
                    </div>
                    <div class="form-group">
                        <div class="slider-value" id="daysValue">1 Day</div>
                        <input type="range" id="days" min="1" max="10" value="1">
                        <div class="slider-labels">
                            <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                            <span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
                        </div>
                    </div>
                    <div class="price-box">
                        <div class="price-row"><span>Total:</span><span id="totalPrice" class="total-price">$100</span></div>
                        <div class="price-row"><span>20% deposit:</span><span id="depositPrice">$20</span></div>
                        <div class="price-row"><span>Remaining:</span><span id="remainingPrice">$80</span></div>
                        <div id="discountInfo" class="discount-info"></div>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <div class="calendar">
                            <div class="calendar-header">
                                <button id="prevMonth">‹</button>
                                <div class="calendar-month" id="currentMonth">December 2025</div>
                                <button id="nextMonth">›</button>
                            </div>
                            <div class="calendar-weekdays">
                                <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
                            </div>
                            <div class="calendar-days" id="calendarDays"></div>
                        </div>
                    </div>
                    <div class="form-group" id="timeContainer">
                        <div class="time-selection">
                            <div class="time-slots" id="timeSlots"></div>
                        </div>
                        <div class="selected-info" id="selectedDateTime">Select date first</div>
                    </div>
                </div>
            </div>
            <div class="buttons">
                <button class="btn btn-primary" id="nextBtn" disabled>Next</button>
            </div>
        </div>

        <!-- Step 2 -->
        <div class="section" id="step2">
            <div class="title" id="step2Title"></div>
            <div class="selected-info" id="step2DateTime" style="margin-bottom:30px"></div>
            <form id="personalForm">
                <div class="form-row">
                    <div class="full-width">
                        <input type="text" id="fullName" class="form-input" placeholder="Full Name *" required>
                        <div class="error" id="nameError">Enter your name</div>
                    </div>
                </div>
                <div class="form-row">
                    <div><input type="tel" id="phone" class="form-input" placeholder="Phone (WhatsApp) *" required>
                         <div class="error" id="phoneError">Valid phone required</div></div>
                    <div><input type="email" id="email" class="form-input" placeholder="Email *" required>
                         <div class="error" id="emailError">Valid email required</div></div>
                </div>
                <div class="form-row">
                    <div class="full-width">
                        <select id="skillLevel" class="custom-select" required>
                            <option value="">Skill Level *</option>
                            <option value="first-time">First Time</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                        <div class="error" id="skillError">Select skill level</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="full-width">
                        <textarea id="notes" class="form-input" rows="4" placeholder="Additional Information (optional)"></textarea>
                    </div>
                </div>
                <div class="price-box">
                    <div class="price-row"><span>Total:</span><span id="totalPrice2" class="total-price">$100</span></div>
                    <div class="price-row"><span>20% deposit:</span><span id="depositPrice2">$20</span></div>
                    <div class="price-row"><span>Remaining:</span><span id="remainingPrice2">$80</span></div>
                    <div id="discountInfo2" class="discount-info"></div>
                </div>
                <div class="buttons">
                    <button type="button" class="btn btn-secondary" id="backBtn">Back</button>
                    <button type="submit" class="btn btn-primary">BOOK NOW</button>
                </div>
            </form>
        </div>

        <!-- Success -->
        <div class="section" id="success">
            <div class="success">
                <div class="success-icon">✅</div>
                <h1 class="success-title">Thank you!</h1>
                <p class="selected-info">Your booking has been submitted successfully.</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        const CONFIG = {
            prices: {2:100, 3:140, full:250},
            minDate: new Date(2025,11,15),
            maxDate: new Date(2026,3,30),
            closeHour: 17,
            startHour: 10
        };

        let state = {
            month: new Date(Math.max(new Date(), CONFIG.minDate)),
            date: null,
            time: null,
            step: 1
        };

        document.addEventListener('DOMContentLoaded', function() {
            state.month.setDate(1);
            initPhone();
            setupEvents();
            renderCalendar();
            updatePrices();
        });

        function initPhone() {
            window.phoneInput = intlTelInput(document.getElementById('phone'), {
                initialCountry: "auto",
                preferredCountries: ['us','gb','fr','de','ru','ge'],
                utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
            });
        }

        function setupEvents() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    updatePrices();
                });
            });

            ['duration','participants','days'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    if(id==='participants') document.getElementById('participantsValue').textContent = 
                        document.getElementById('participants').value + ' Person' + (document.getElementById('participants').value>1?'s':'');
                    if(id==='days') document.getElementById('daysValue').textContent = 
                        document.getElementById('days').value + ' Day' + (document.getElementById('days').value>1?'s':'');
                    updatePrices();
                });
            });

            document.getElementById('nextBtn').addEventListener('click', () => showStep(2));
            document.getElementById('backBtn').addEventListener('click', () => showStep(1));
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
            document.getElementById('personalForm').addEventListener('submit', handleSubmit);
        }

        function showStep(step) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(step===1?'step1':step===2?'step2':'success').classList.add('active');
            state.step = step;
            
            if(step === 2) {
                document.getElementById('step2Title').textContent = getBookingTitle();
                document.getElementById('step2DateTime').textContent = document.getElementById('selectedDateTime').textContent;
            }
            
            // Надежный скролл наверх
            setTimeout(() => {
                window.scrollTo({top: 0, behavior: 'smooth'});
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;
            }, 50);
        }

        function updatePrices() {
            const data = calculatePrice();
            ['','2'].forEach(suffix => {
                document.getElementById(`totalPrice${suffix}`).textContent = `$${data.total}`;
                document.getElementById(`depositPrice${suffix}`).textContent = `$${data.deposit}`;
                document.getElementById(`remainingPrice${suffix}`).textContent = `$${data.remaining}`;
                document.getElementById(`discountInfo${suffix}`).textContent = data.discountText;
            });
        }

        function calculatePrice() {
            const duration = document.getElementById('duration').value;
            const people = parseInt(document.getElementById('participants').value);
            const days = parseInt(document.getElementById('days').value);
            
            let base = CONFIG.prices[duration];
            const perDay = base + (people - 1) * 40;
            
            let total = 0;
            let maxDiscount = 0;
            
            for(let day=1; day<=days; day++) {
                let discount = day>=8?0.20:day>=6?0.15:day>=4?0.10:0;
                total += perDay * (1 - discount);
                if(discount > maxDiscount) maxDiscount = discount;
            }
            
            total = Math.round(total);
            const deposit = Math.round(total * 0.20);
            const remaining = total - deposit;
            
            const discountText = maxDiscount>0?`🎉 Save ${maxDiscount*100}% on days ${maxDiscount===0.20?'8+':maxDiscount===0.15?'6-7':'4-5'}`:'';
            
            return {total, deposit, remaining, discountText};
        }

        function renderCalendar() {
            const year = state.month.getFullYear();
            const month = state.month.getMonth();
            
            document.getElementById('currentMonth').textContent = state.month.toLocaleDateString('en-US',{month:'long',year:'numeric'});
            
            const first = new Date(year, month, 1);
            const last = new Date(year, month+1, 0);
            const start = first.getDay()===0?6:first.getDay()-1;
            
            document.getElementById('calendarDays').innerHTML = '';
            
            const prevLast = new Date(year, month, 0).getDate();
            for(let i=start-1; i>=0; i--) createDay(prevLast-i, 'other-month disabled', true);
            
            const today = new Date(); today.setHours(0,0,0,0);
            for(let day=1; day<=last.getDate(); day++) {
                const date = new Date(year, month, day);
                let cls = 'calendar-day';
                if(date.toDateString()===today.toDateString()) cls += ' today';
                if(date < CONFIG.minDate || date > CONFIG.maxDate || date < today) {
                    createDay(day, cls+' disabled', true);
                } else {
                    if(state.date && state.date.toDateString()===date.toDateString()) cls += ' selected';
                    createDay(day, cls, false, date);
                }
            }
            
            const nextDays = 42 - (start + last.getDate());
            for(let day=1; day<=nextDays; day++) createDay(day, 'other-month disabled', true);
            
            updateTimes();
        }

        function createDay(day, className, disabled, date=null) {
            const btn = document.createElement('button');
            btn.className = className;
            btn.textContent = day;
            btn.disabled = disabled;
            
            if(!disabled && date) {
                btn.addEventListener('click', () => {
                    state.date = date;
                    renderCalendar();
                    updateTimes();
                    updateDateTime();
                    document.getElementById('nextBtn').disabled = !state.time;
                    
                    setTimeout(() => {
                        document.getElementById('timeContainer').scrollIntoView({behavior:'smooth',block:'start'});
                    }, 300);
                });
            }
            
            document.getElementById('calendarDays').appendChild(btn);
        }

        function changeMonth(dir) {
            state.month.setMonth(state.month.getMonth() + dir);
            renderCalendar();
        }

        function updateTimes() {
            document.getElementById('timeSlots').innerHTML = '';
            
            if(!state.date) {
                document.getElementById('timeSlots').innerHTML = '<div class="time-slot disabled">Select date</div>';
                document.getElementById('nextBtn').disabled = true;
                return;
            }

            const duration = document.getElementById('duration').value;
            
            if(duration === 'full') {
                createTime('10:00', '10:00 (Full day)');
            } else {
                const hours = parseInt(duration);
                for(let h=CONFIG.startHour; h<=CONFIG.closeHour-hours; h++) {
                    createTime(`${h}:00`);
                }
            }
        }

        function createTime(timeStr, text=null) {
            const slot = document.createElement('button');
            slot.className = 'time-slot';
            slot.textContent = text || timeStr;
            
            if(state.time === timeStr) slot.classList.add('selected');
            
            slot.addEventListener('click', function() {
                document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                state.time = timeStr;
                this.classList.add('selected');
                updateDateTime();
                document.getElementById('nextBtn').disabled = false;
            });
            
            document.getElementById('timeSlots').appendChild(slot);
        }

        function updateDateTime() {
            if(state.date && state.time) {
                const dateStr = state.date.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
                document.getElementById('selectedDateTime').textContent = `${dateStr} at ${state.time}`;
            }
        }

        function getBookingTitle() {
            const sport = document.querySelector('.tab.active').dataset.sport;
            const duration = document.getElementById('duration').value;
            const people = parseInt(document.getElementById('participants').value);
            const days = parseInt(document.getElementById('days').value);
            
            const durText = {2:'2 Hours',3:'3 Hours',full:'Full Day'}[duration];
            const sportText = sport.charAt(0).toUpperCase() + sport.slice(1);
            const peopleText = people===1?'':` with ${people} Persons`;
            const daysText = days===1?'':` x ${days} Days`;
            
            return `${durText} ${sportText} Lesson${peopleText}${daysText}`;
        }

        function handleSubmit(e) {
            e.preventDefault();
            if(!validateForm()) return;
            
            const data = getFormData();
            sendEmail(data);
            showStep(3);
        }

        function validateForm() {
            let valid = true;
            if(!document.getElementById('fullName').value.trim()) {
                showError('nameError','Enter full name'); valid=false;
            } else hideError('nameError');
            
            if(!window.phoneInput.isValidNumber()) {
                showError('phoneError','Valid phone required'); valid=false;
            } else hideError('phoneError');
            
            if(!document.getElementById('email').value.match(/^\S+@\S+\.\S+$/)) {
                showError('emailError','Valid email required'); valid=false;
            } else hideError('emailError');
            
            if(!document.getElementById('skillLevel').value) {
                showError('skillError','Select skill level'); valid=false;
            } else hideError('skillError');
            
            return valid;
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.classList.add('show');
        }

        function hideError(id) {
            document.getElementById(id).classList.remove('show');
        }

        function getFormData() {
            const duration = document.getElementById('duration').value;
            const people = parseInt(document.getElementById('participants').value);
            const days = parseInt(document.getElementById('days').value);
            const sport = document.querySelector('.tab.active').dataset.sport;
            
            const durText = {2:'2 Hours',3:'3 Hours',full:'Full Day'}[duration];
            const sportText = sport.charAt(0).toUpperCase() + sport.slice(1);
            const peopleText = people===1?'1 Person':`${people} Persons`;
            
            const price = calculatePrice();
            
            return {
                subject: `Booking: ${durText} ${sportText} Lesson with ${peopleText} x ${days} days`,
                durText, sportText, peopleText, days,
                dateTime: document.getElementById('selectedDateTime').textContent,
                name: document.getElementById('fullName').value,
                phone: window.phoneInput.getNumber(),
                email: document.getElementById('email').value,
                skill: document.getElementById('skillLevel').options[document.getElementById('skillLevel').selectedIndex].text,
                notes: document.getElementById('notes').value,
                total: price.total, deposit: price.deposit, remaining: price.remaining
            };
        }

        function sendEmail(data) {
            const body = `
${data.durText} ${data.sportText} Lesson with ${data.peopleText} x ${data.days} days
${data.dateTime}

Name: ${data.name}
Phone: https://wa.me/${data.phone.replace('+','')}
Email: ${data.email}
Skill: ${data.skill}
Notes: ${data.notes || 'None'}

Total: $${data.total}
Deposit: $${data.deposit}
Remaining: $${data.remaining}
            `.trim();

            emailjs.init('gb9ZTULk6-ghDtZuV');
            emailjs.send('service_0tuoznd','template_jiiwo1f',{
                to_email:'info@skischool.ge', subject:data.subject, message:body,
                from_name:data.name, from_email:data.email, phone:data.phone
            }).catch(() => {
                const mailto = `mailto:info@skischool.ge?subject=${encodeURIComponent(data.subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailto, '_blank');
            });
        }
    </script>
</body>
</html>
