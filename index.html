<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Form - SkiSchool.ge</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <script src="https://www.paypal.com/sdk/js?client-id=AUFAuKE5jRCH1Ucd72VfmAn5xR0v9Nyg27zWWi1kCjyqKVxgb3bNxWgZ21WxoeC3dP8U122SfuhMu4Qm&currency=USD"></script>
    <style>
        /* Стили остаются такими же как в предыдущей версии */
        /* ... весь CSS код ... */
    </style>
</head>
<body>
    <!-- HTML структура остается такой же -->
    <!-- ... весь HTML код ... -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        const CONFIG = {
            prices: {
                2: 100, 
                3: 140, 
                full: 250,
                kids: {
                    'full': 150,
                    'half-lunch': 110,
                    'half-nolunch': 90
                }
            },
            minDate: new Date(2025, 11, 15),
            maxDate: new Date(2026, 3, 30),
            resortCloseHour: 17,
            lessonStartHour: 10
        };

        // ... остальной JavaScript код формы ...

        function initPayPal() {
            paypalButtons = paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'gold',
                    shape: 'pill',
                    label: 'paypal',
                    height: 55
                },
                createOrder: function(data, actions) {
                    const depositAmount = document.getElementById('depositPriceStep3').textContent.replace('$', '');
                    const bookingDetails = State.getBookingSummary();
                    
                    return actions.order.create({
                        purchase_units: [{
                            description: `Booking Deposit - ${bookingDetails.title} Reservation`,
                            amount: {
                                value: depositAmount,
                                currency_code: 'USD'
                            },
                            custom_id: generateBookingId()
                        }],
                        application_context: {
                            shipping_preference: 'NO_SHIPPING'
                        }
                    });
                },
                onApprove: function(data, actions) {
                    showPaymentProcessing();
                    return actions.order.capture().then(function(details) {
                        const formData = getFormData();
                        formData.paymentStatus = 'completed';
                        formData.paymentId = details.id;
                        formData.payerEmail = details.payer.email_address;
                        
                        // Отправка данных в бот через вебхук
                        sendToBot(formData);
                        
                        // Отправка email
                        sendEmail(formData, 'Booking Confirmation');
                        
                        setTimeout(showSuccess, 1000);
                    });
                },
                onCancel: function(data) {
                    const formData = getFormData();
                    formData.paymentStatus = 'cancelled';
                    sendEmail(formData, 'Booking Incomplete');
                    alert('Payment was cancelled. Please try again to complete your booking.');
                },
                onError: function(err) {
                    const formData = getFormData();
                    formData.paymentStatus = 'failed';
                    formData.error = err.toString();
                    sendEmail(formData, 'Booking Incomplete');
                    alert('An error occurred with the payment. Please try again.');
                    showStep(3);
                }
            });

            if (paypalButtons.isEligible()) {
                paypalButtons.render('#paypal-button-container');
            }
        }

        // Функция отправки данных в бот
        function sendToBot(formData) {
            const webhookUrl = window.location.hostname === 'localhost' 
                ? 'http://localhost:8080/webhook/booking'
                : 'https://skischoolgebot-production.up.railway.app/webhook/booking';
            
            const bookingData = {
                fullName: formData.fullName,
                phone: formData.phone,
                email: formData.email,
                age: formData.age,
                skillLevel: formData.skillLevel,
                additionalInfo: formData.additionalInfo,
                sport: State.currentSport,
                duration: State.currentSport === 'kids' ? 
                    document.getElementById('kidsDurationSelect').value : 
                    document.getElementById('duration').value,
                participants: State.currentSport === 'kids' ? 
                    document.getElementById('kids').value : 
                    document.getElementById('participants').value,
                days: State.currentSport === 'kids' ? 
                    document.getElementById('kidsDaysSlider').value : 
                    document.getElementById('days').value,
                date: State.selectedDate ? State.selectedDate.toISOString().split('T')[0] : '',
                time: State.selectedTime || '',
                total: formData.total,
                deposit: formData.deposit,
                remaining: formData.remaining,
                bookingId: formData.bookingId,
                paymentStatus: 'completed'
            };

            console.log('Sending booking data to bot:', bookingData);

            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(bookingData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Booking data sent to bot successfully:', data);
                if (!data.success) {
                    console.error('Bot returned error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error sending booking data to bot:', error);
                // Показываем успех даже если отправка в бот не удалась
                // Пользователь уже оплатил, это системная ошибка
            });
        }

        // ... остальные функции формы ...
    </script>
</body>
</html>
